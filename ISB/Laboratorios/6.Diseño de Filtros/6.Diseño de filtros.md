# Laboratorio 6: Diseño de filtros
## Tabla de contenidos:
* [Objetivos](#objetivos)
* [Filtros IIR , FIR Y WAVELET](#filtro)
* [Entregables](#entregable)
 
  * [Filtrado de señal EMG ](#emg)
  * [Explicación de los filtros de señales EMG](#explicación-emg)
  * [Filtrado de señal ECG ](#ecg)
  * [Explicación de los filtros de señales ECG](#explicación-emg)
  * [Filtrado de señal EEG ](#eeg)
  * [Explicación de los filtros de señales EEG](#explicación-emg)


 
* [Bibliografía](#bibliografía)
 
## Objetivos:
 -  Diseñar 1 filtro FIR, y  elegir  métodos de ventana entre Hanning, Hamming,Bartlett, rectangular o Blackman para cada señal EMG , ECG Y EEG

 - Diseñar 1 filtro IIR, elegir entre  Bessel, Butterworth, Chebyshev o Eliptico para cada señal EMG , ECG Y EEG
   
 - Diseñar 1 filtro de Wavelet para cada señal EMG , ECG Y EEG

- Comparar los métodos y concluir el que tuvo mejor rendimiento

## Filtros IIR , FIR Y WAVELET


### Filtrado de señal EMG 

### Filtrado de señal FIR
Se diseñaron dos tipos de filtros , como principal , se empleó un filtro pasabajo con una frecuencia de corte de 80 hz. Se empleó la ventana hamming debido a su mejor atenuación en comparación a las otras ventanas hamming , hanning , barlett y triangular.





![RTGyj](https://github.com/arianacarbajal/ISB_Grupo3/blob/1c49cfc072b9a785cf35610b345a3bc397889e91/Imagen/Se%C3%B1alORIGINAL.png)
Señal original 


![Texto alternativo](https://github.com/arianacarbajal/ISB_Grupo3/blob/15dab86527e86278b09ff615e7510a0771710240/Imagen/se%C3%B1al_filtradaFIR.png)
Señal filtrada con FIR


![Texto alternativo](https://github.com/arianacarbajal/ISB_Grupo3/blob/5e412ddca2c0838364eb0992c5c8a320cef15974/Imagen/se%C3%B1alfiltrada_IIR.png)
Señal filtrada con IIR

![Texto alternativo](ISB/Laboratorios/Imagenes/ecg_fir.png)
Señal filtrada con Wavelet



### Explicación de los filtros de señales EMG

### Filtrado de señal ECG 
   ![Texto alternativo](ISB/Laboratorios/Imagenes/Imagen2.png)
Señal filtrada con IIR
   ![Texto alternativo](ISB/Laboratorios/Imagenes/ecg_fir.png)
Señal filtrada con FIR
   
### Explicación de los filtros de señales EEG
### Filtrado de señal EEG FIR
Se diseñaron dos tipos de filtros , como principal , se empleó un filtro pasabajo con una frecuencia de paso de 30 Hz , una frecuencia de stop de 40 Hz y un orden de 600. Se empleó la ventana blackman debido a su mejor atenuación en comparación a las otras ventanas hamming , hanning , barlett y triangular.La ventana blackman ofrece Blackman superior supresión de lóbulos laterales (amplitud máxima de -57 dB)y  capacidades efectivas de reducción de ruido  (error de aproximación de pico bajo de -74 dB).

![RTGyj](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/0a07969a-979f-4403-abbb-eea1c17d387b)

Imagen: Características de ventanas[A1]


‌
Se situo a la frecuencia de corte en 0.07 aprox de frecuencia normalizada rad /pi  o 35 Hz ya que las señales EEG tienen frecuencias en este rango de 0 a 35 Hz son las frecuencias de interés referidas a las ondas beta, alpha , delta y theta. y filtrarlo a esa frecuencia también nos eliminaria el ruido en 60 Hz proveniente de la alimentación electrica que se muy pronunciado al calcular la FFT inicial.


![descarga (1)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/2f7ba046-0376-4c73-96c1-0c526e0e4ee2)

Imagen : Señal EEG bitalino al realizar abrir y cerrar de ojos

![descarga (2)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/b19a9dab-2e0e-4b97-ba5c-bae3acfb3264)

Imagen:FFT de la señal inicial

En la respuesta en frecuencia del filtro pasabajo podemos ver su comportamiento y como va a filtrar adecuadamente el ruido de 60 hz, y vemos como tiene una correcta atenuación para las frecuencias de paso y corte que hemos indicado . 
![descarga (3)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/09c15a75-b7ad-404e-bab0-253d40ced044)

Imagen: Respuesta en frecuencia del filtro en Hz

![descarga (4)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/0885e2c2-5462-4f49-a77a-b9ea4197d597)

Imagen : Señal EEG bitalino al realizar abrir y cerrar de ojos filtrada


En la FFT de la señal filtrada podemos observar que se ha reducido completamente el ruido de 60 hz ya que ya no vemos ese pico prominente

![descarga (5)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/93ed75ae-8f3a-43f4-a11a-f516ead5fbe2)

Imagen:FFT de la señal filtrada 

Observamos como para este filtro se requirio un orden de 600 , lo cual requiere bastante costo computacional , pero que atenuo correctamente el ruido deseado
### Codigo utilizado para el filtro pasabajo FIR
```

# Definir frecuencia de corte del filtro pasabajo
wp = 30  / (Fs / 2) # frecuencia de paso
ws = 40  / (Fs / 2) # frecuencia de stop
wc=(wp + ws) / 2 #frecuencia de corte

dw= ws-wp

lowpass_filter= firwin(numtaps=M, cutoff=wc,  window='hamming')

# Definir el orden del filtro
M =  int(np.floor(12 / dw))
print(M)


wHz, Y = fft_fun(lowpass_filter, Fs)

plt.figure(figsize=(8, 6))

plt.plot(wHz, np.abs(Y), "r")
plt.xlabel("Frequencia (Hz)")
plt.ylabel("Amplitud")
plt.title("Respuesta en frecuencia del filtro")
plt.xlim(0, 60)



filtered_signal = lfilter(lowpass_filter, 1, eeg)

wHz, filtered_signal_fft = fft_fun(filtered_signal, Fs)

t = np.arange(1, len(filtered_signal)+1)/Fs

```

El segundo filtro empleado fue el filtro pasabanda , este se utilizó para adquirir las bandas delta, theta, alfa y beta .
Nos basamos en el árticulo "Technological Basics of EEG Recording and Operation of Apparatus" para obtener las frecuencias de corte de las bandas deseadas .

![image](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/38eec8de-3c0f-4a98-9d35-7e1da98945e9)

Imagen: Frecuencias de bandas delta, theta, alfa y beta [1]

Con estas frecuencias pudimos realizar los 4 filtros pasabandas para extraer las ondas cerebrales de la señal EEG, aqui tambien se empleo ventana blackman debido a su mejor atenuación.


![señalesfiltr](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/62648f36-1738-4270-8497-0c7ba7f16b30)

Imagen:Ondas cerebrales bandas delta, theta, alfa y beta a partir de señal EEG

![fftband](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/3e97a461-0abc-430d-a4ef-12a9904c0b38)

Imagen:FFT Ondas cerebrales bandas delta, theta, alfa y beta 

Finalmente podemos observar como las señales han sido filtradas correctamente , se pudo segmentar la señal EEG en sus 4 bandas principales y esto también se puede comprobar en las gráficas de FFT en las cuales vemos como la señal de una banda corresponde a el intervalo de frecuencias dado , ya que podemos observar a las ondas delta de 0.5 a 4 Hz , ondas theta de 4 a 8 hZ , ondas alpha de 8 a 12 hz y por último las ondas beta de 12 a 35 Hz.




### Codigo utilizado para el filtro pasabanda FIR
```
# Definir la longitud de la ventana y la frecuencia de muestreo
M = 1000

# Definir las frecuencias de corte para las bandas de interés
f_delta = (0.5, 4)  # Frecuencia para la banda delta (en Hz)
f_theta = (4, 8)    # Frecuencia para la banda theta (en Hz)
f_alpha = (8, 12)   # Frecuencia para la banda alfa (en Hz)
f_beta = (12, 35)   # Frecuencia para la banda beta (en Hz)



# Crear los filtros para cada banda
f1=0.5/(0.5 * Fs)
f2=4/(0.5 * Fs)
w_delta = firwin(numtaps=M, cutoff=[f1 ,f2], pass_zero=False , window='blackman')
f1=4/(0.5 * Fs)
f2=8/(0.5 * Fs)
w_theta = firwin(numtaps=M, cutoff=[f1 ,f2], pass_zero=False , window='blackman')
f1=8/(0.5 * Fs)
f2=12/(0.5 * Fs)
w_alpha = firwin(numtaps=M, cutoff=[f1 ,f2], pass_zero=False , window='blackman')
f1=12/(0.5 * Fs)
f2=35/(0.5 * Fs)
w_beta = firwin(numtaps=M, cutoff=[f1 ,f2], pass_zero=False , window='blackman')


# Aplicar cada filtro pasabanda a la señal EEG
eeg_delta = lfilter(w_delta, 1, eeg)
eeg_theta = lfilter(w_theta, 1, eeg)
eeg_alpha = lfilter(w_alpha, 1, eeg)
eeg_beta = lfilter(w_beta, 1, eeg)

# Calcular la transformada de Fourier de cada banda
wHz_delta, delta_spectrum = fft_fun(eeg_delta, Fs)
wHz_theta, theta_spectrum = fft_fun(eeg_theta, Fs)
wHz_alpha, alpha_spectrum = fft_fun(eeg_alpha, Fs)
wHz_beta, beta_spectrum = fft_fun(eeg_beta, Fs)


# Plot de cada banda
plt.figure(figsize=(12, 8))

# Delta
plt.subplot(4, 1, 1)
plt.plot(wHz_delta, delta_spectrum, "r")
plt.xlabel("Frequencia (Hz)")
plt.ylabel("Amplitud")
plt.title("Banda Delta  FFT")
plt.xlim(0, 40)

# Theta
plt.subplot(4, 1, 2)
plt.plot(wHz_theta, theta_spectrum, "g")
plt.xlabel("Frequencia (Hz)")
plt.ylabel("Amplitud")
plt.title(" Banda Theta FFT")
plt.xlim(0, 40)

# Alpha
plt.subplot(4, 1, 3)
plt.plot(wHz_alpha, alpha_spectrum, "b")
plt.xlabel("Frequencia (Hz)")
plt.ylabel("Amplitud")
plt.title(" Banda Alpha FFT")
plt.xlim(0, 40)

# Beta
plt.subplot(4, 1, 4)
plt.plot(wHz_beta, beta_spectrum, "m")
plt.xlabel("Frequencia (Hz)")
plt.ylabel("Amplitud")
plt.title(" Banda Beta FFT")
plt.xlim(0, 40)

```
### Filtrado de señal EEG IIR

Se diseñó un filtro Butterworth IIR  pasabajo con una frecuencia de paso de 35 Hz y una frecuencia de parada de 55 Hz. El filtro Butterworth es ampliamente reconocido por su respuesta en frecuencia suave, lo que significa que maximiza la planicidad en la banda de paso. A diferencia del filtro FIR empleado previamente, el filtro Butterworth IIR se caracteriza por su orden significativamente más bajo, en este caso, un orden de 16. Esto se traduce en una menor complejidad computacional y recursos requeridos para su implementación.

La especificación de gpass se fijó en 3, lo que permitió una variación máxima de 3 dB en la ganancia dentro de la banda de paso. Además, gstop se estableció en 60, indicando que se necesitaba una atenuación mínima de 60 dB en la banda de parada. 

Como se puede se puede observar en la tercera gráfica de la FFT de la señal filtrada,  el filtro Butterworth IIR demostró un gran rendimiento al eliminar eficazmente el ruido no deseado a 60 Hz en la señal.

![descarga (7)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/ac5f1f8e-b544-48ee-b747-1a5005cf36ae)

Imagen: Respuesta en frecuencia del filtro  IIR pasabajo en DB

![descarga (8)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/3a8d6b3e-a026-4c84-ad55-93758e2388f9)

Imagen: Señal EEG Bitalino filtrada mediante Butterworth y transformación billineal IIR

‌![descarga (9)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/a96465b0-377a-4117-b5fa-e00f7fb1e59b)

Imagen: FFT de señal EEG Bitalino filtrada IIR


### Codigo utilizado para el filtro pasabaja IIR
```
wp=2*np.pi*35
ws=2*np.pi*55

N_ord, Wc= signal.buttord(wp, ws, gpass=3, gstop=60, analog=True) #gpass=loss in passband edge frecuencies, gstop= attenuation in stopband edge frecuencies 
fc = np.round(Wc/(2*np.pi) ,2) 

print(f"Orden del filtro: {N_ord}")
print(f"Frecuencia de corte calculada: {fc} hz")

# Funcion de transferencia del filtro pasa bajo analogico
b,a = signal.butter(N_ord, Wc, 'lowpass', True, 'ba')

# Respuesta en frecuencia del filtro analogico
Fmax=400
F_freqs = np.linspace(0,Fmax,1000)
W_freqs = 2*np.pi*F_freqs  #Angular frecuences

W_freqs, H = signal.freqs(b,a,W_freqs)
Hm=np.abs(H)
plt.plot(F_freqs, 20 * np.log10(Hm))
plt.grid(linestyle=":")
plt.xlabel("Frecuencia (hz)")
plt.ylabel("Magnitud (db)")


bd, ad = signal.bilinear(b,a,Fs)

Wz, Hd = signal.freqz(bd, ad, W_freqs/Fs)

Hdm = np.abs(Hd)
plt.plot(F_freqs, 20 * np.log10(Hdm))
plt.grid(linestyle=":")
plt.xlabel("Frecuencia (hz)")
plt.ylabel("Magnitud (db)")
plt.title('Respuesta en frecuencia del filtro en DB')

```
### Filtrado de ruido del EEG mediante transformada wavelet
Para la supresión de ruido, se utilizó la transformada wavelet con una configuración de 3 niveles y un umbral de 5.6. Dado que la característica principal de la señal de EEG son los picos que aparecen cada 5 segundos, se buscó que la señal filtrada conservara estos picos, que son los más distintivos. Para lograr esto, se revisó la bibliografía sobre la transformada discreta de wavelet como método de filtrado de ruido en EEG. Se encontró que se pueden utilizar de 3 a 5 niveles con "db4", y el umbral se ajusta empíricamente. En función de nuestras necesidades, optamos por la mejor configuración, que consiste en 3 niveles y un umbral de 5.6. Este último valor se determinó empíricamente, y logramos generar una señal con los picos correspondientes al parpadeo cada 5 segundos.

 ![download](https://github.com/arianacarbajal/ISB_Grupo3/assets/56054823/7df35a18-200a-439d-a464-0c5a5c66189c)
 
![download](https://github.com/arianacarbajal/ISB_Grupo3/assets/56054823/de2588a4-ed5d-4de7-bdcf-05c7e0f9ad30)
‌
### Explicación de los filtros de señales EEG
En comparación con el filtro FIR utilizado previamente, el filtro Butterworth IIR presenta notables diferencias en términos de orden (mucho menor en el caso del IIR), frecuencia de corte, costo computacional (menor para IIR), y requisitos de recursos. A pesar de estas diferencias, ambos filtros lograron satisfactoriamente la eliminación del ruido no deseado, demostrando su eficacia en diferentes aplicaciones de filtrado.Además los filtros IIR en ocasiones pueden ocasionar desplazos en la señal , siendo no ideal para aplicaciones en tiempo real.


### Archivos 
Por otro lado podemos encontrar los archivos de la informacion de las señales ploteadas 

-[Archivos txt de cada señal elegida](https://github.com/arianacarbajal/ISB_Grupo3/tree/653423cd07d02ac7c8834c24e35e20a8a23843a6/ISB/Laboratorios/6.Dise%C3%B1o%20de%20Filtros/txt)

-[Archivos ipny con código para tipo señal](https://github.com/arianacarbajal/ISB_Grupo3/tree/653423cd07d02ac7c8834c24e35e20a8a23843a6/ISB/Laboratorios/6.Dise%C3%B1o%20de%20Filtros/ipny)



TABLA DE RESUMEN SEÑALES FILTRADAS
|Señal | FILTRO FIR | FILTRO IIR | FILTRO WAVELET |
|----------|----------|----------|----------|
| EMG | ![Imagen 2](https://github.com/arianacarbajal/ISB_Grupo3/assets/89601813/2939138d-a0e0-46f4-a3bd-9661c2010eba) | ![Imagen 3](https://github.com/arianacarbajal/ISB_Grupo3/assets/89601813/928f9e72-7435-4e6f-bf00-585df693fd64) | ![Imagen 4](https://github.com/arianacarbajal/ISB_Grupo3/assets/89601813/fd07dce0-2437-4ff5-bc3e-0587cb9fc34c) |
|ECG| ![Imagen 6](https://github.com/arianacarbajal/ISB_Grupo3/assets/89601813/b6851cb1-533e-4c0f-b494-b66be33111df) | ![Imagen 7](https://github.com/arianacarbajal/ISB_Grupo3/assets/89601813/f4c61204-d5a4-4d68-aafb-b3e04556cd1d) | ![Imagen 8](https://github.com/arianacarbajal/ISB_Grupo3/assets/89601813/db1c14dc-2143-4d97-bdc0-a3082cbcd997) |
|EEG| ![descarga (6)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/8cc31c84-74f2-4ddf-bfff-1033cc68c3c9)|![descarga (8)](https://github.com/arianacarbajal/ISB_Grupo3/assets/56159840/82c9f450-3d81-4a87-a3b6-e6b264f2bdde)| ![download](https://github.com/arianacarbajal/ISB_Grupo3/assets/56054823/22bfaa21-98f6-4a24-9ea1-2be226b5e766)








## Bibliografía

‌[A1]Why, “Why would one use a Hann or Bartlett window?,” Signal Processing Stack Exchange, Apr. 28, 2017. Available: https://dsp.stackexchange.com/questions/40598/why-would-one-use-a-hann-or-bartlett-window. [Accessed: Oct. 20, 2023]

[A2] P. A. Abhang, B. W. Gawali, and S. C. Mehrotra, “Technological Basics of EEG Recording and Operation of Apparatus,” Elsevier eBooks, pp. 19–50, Jan. 2016, doi: https://doi.org/10.1016/b978-0-12-804490-2.00002-6. Available: https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/brain-waves. [Accessed: Oct. 20, 2023]
